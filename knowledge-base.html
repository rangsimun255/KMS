<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Knowledge Base - KMS</title>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Sarabun', sans-serif;
      background-color: #e8eef5;
      min-height: 100vh;
      overflow-x: hidden;
    }
    .container { display: flex; min-height: 100vh; }

    .sidebar {
      width: 70px;
      background: linear-gradient(180deg, #5b9bd5 0%, #4a89c8 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 20px;
      gap: 10px;
      position: fixed;
      height: 100vh;
      left: 0;
      top: 0;
      z-index: 100;
    }
    .sidebar-icon {
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(255,255,255,0.7);
      font-size: 20px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
    }
    .sidebar-icon:hover,
    .sidebar-icon.active {
      background-color: rgba(255,255,255,0.2);
      color: #fff;
    }

    .main-content {
      flex: 1;
      padding: 0;
      margin-left: 70px;
      width: calc(100% - 70px);
    }

    .header {
      background: linear-gradient(135deg, #5b9bd5 0%, #2e75b6 100%);
      padding: 40px;
      text-align: center;
    }
    .header h1 {
      font-size: 32px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 10px;
    }
    .header p {
      font-size: 16px;
      color: rgba(255,255,255,0.9);
    }

    .filter-section {
      background: #fff;
      padding: 25px 40px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .filter-row {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      align-items: center;
    }
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .filter-group label {
      font-size: 14px;
      font-weight: 600;
      color: #2c3e50;
    }
    .filter-group select {
      padding: 10px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      min-width: 180px;
    }
    .filter-group select:focus { border-color: #5b9bd5; outline: none; }

    .checkbox-group {
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .checkbox-item input { width: 18px; height: 18px; }
    .checkbox-item label { font-size: 14px; cursor: pointer; }

    .btn-clear {
      padding: 10px 20px;
      background: #e74c3c;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
    }
    .btn-clear:hover { background: #c0392b; }

    .cards-section { padding: 30px 40px; }
    .cards-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; }

    .card {
      background: #fff;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      transition: all 0.3s ease;
    }
    .card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(91,155,213,0.2); }
    .card-image { width: 100%; height: 200px; object-fit: cover; background: #f0f0f0; }
    .card-content { padding: 20px; }

    .card-type {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 10px;
    }
    .card-type.opl { background: #e8f5e9; color: #2e7d32; }
    .card-type.wi { background: #e3f2fd; color: #1565c0; }
    .card-type.video { background: #fff3e0; color: #ef6c00; }
    .card-type.experience { background: #fce4ec; color: #c2185b; }

    .card-title { font-size: 16px; font-weight: 600; color: #2c3e50; margin-bottom: 8px; }
    .card-info { font-size: 13px; color: #7f8c8d; margin-bottom: 5px; }

    .card-btn {
      display: inline-block;
      padding: 10px 20px;
      background: #5b9bd5;
      color: #fff;
      text-decoration: none;
      border-radius: 8px;
      font-size: 14px;
      margin-top: 10px;
    }
    .card-btn:hover { background: #4a89c8; }

    .no-results { text-align: center; padding: 60px; color: #7f8c8d; }
    .no-results i { font-size: 60px; margin-bottom: 20px; color: #bdc3c7; }

    @media (max-width: 1200px) {
      .cards-grid { grid-template-columns: repeat(2, 1fr); }
      .cards-section { padding: 20px 24px; }
      .filter-section { padding: 16px 24px; }
    }

    @media (max-width: 768px) {
      .container { flex-direction: column !important; }

      .sidebar {
        width: 100% !important;
        height: 60px !important;
        flex-direction: row !important;
        justify-content: center !important;
        align-items: center !important;
        position: relative !important;
        left: auto !important;
        top: auto !important;
        padding-top: 0 !important;
        padding: 10px !important;
        gap: 12px !important;
      }

      .main-content { margin-left: 0 !important; width: 100% !important; }

      .header { padding: 24px 16px; }
      .header h1 { font-size: 24px; }
      .header p { font-size: 14px; }

      .filter-section { padding: 14px 16px; }
      .filter-row { flex-direction: column !important; align-items: stretch !important; gap: 12px; }
      .filter-group select { width: 100% !important; min-width: 0 !important; }
      .btn-clear { width: 100%; }

      .cards-section { padding: 16px; }
      .cards-grid { grid-template-columns: 1fr !important; gap: 14px; }
      .card-image { height: 160px; }
      .card-content { padding: 14px; }
      .card-btn { width: 100%; text-align: center; }
    }
  </style>
</head>

<body>
  <div class="container">
   <nav class="sidebar">
  <a class="sidebar-icon" data-page="index" href="index.html"><i class="fas fa-home"></i></a>
  <a class="sidebar-icon" data-page="kb" href="knowledge-base.html"><i class="fas fa-book"></i></a>
  <a class="sidebar-icon" data-page="lp" href="learning-path.html"><i class="fas fa-graduation-cap"></i></a>
  <a class="sidebar-icon" data-page="quiz" href="quiz.html"><i class="fas fa-clipboard-check"></i></a>
  <a class="sidebar-icon" data-page="share" href="share-experience.html"><i class="fas fa-comments"></i></a>
  <a class="sidebar-icon logout" href="logout.html"><i class="fas fa-sign-out-alt"></i></a>
</nav>


    <main class="main-content">
      <header class="header">
        <h1>Knowledge Base</h1>
        <p>คลังความรู้ เทคนิค และวิธีแก้ปัญหาในกระบวนการผลิตยาสมุนไพร</p>
      </header>

      <section class="filter-section">
        <div class="filter-row">
          <div class="filter-group">
            <label>กระบวนการ:</label>
            <select id="filterProcess">
              <option value="">-- ทั้งหมด --</option>
              <option value="1">1. ผสมเปียก</option>
              <option value="2">2. แร่งเปียก</option>
              <option value="3">3. อบลมร้อน</option>
              <option value="4">4. แร่งแห้ง</option>
              <option value="5">5. ผสมแห้ง</option>
              <option value="6">6. ตอกเม็ดยา</option>
              <option value="7">7. บรรจุซอง</option>
            </select>
          </div>

          <div class="filter-group">
            <label>ลักษณะของเสีย:</label>
            <select id="filterDefect">
              <option value="">-- ทั้งหมด --</option>
            </select>
          </div>

          <div class="filter-group">
            <label>ประเภท:</label>
            <div class="checkbox-group">
              <div class="checkbox-item">
                <input type="checkbox" id="typeOPL" value="OPL" checked>
                <label for="typeOPL">OPL</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="typeWI" value="WI" checked>
                <label for="typeWI">WI</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="typeVideo" value="Video" checked>
                <label for="typeVideo">Video</label>
              </div>
              <div class="checkbox-item">
                <input type="checkbox" id="typeExp" value="Experience" checked>
                <label for="typeExp">Experience</label>
              </div>
            </div>
          </div>

          <button class="btn-clear" onclick="clearFilters()">ล้างตัวกรอง</button>
        </div>
      </section>

      <section class="cards-section">
        <div class="cards-grid" id="cardsContainer">
          <div class="no-results">
            <i class="fas fa-spinner fa-spin"></i>
            <p>กำลังโหลดข้อมูล...</p>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbwMRbnqSLTmmI4wofmNfZ5YPFGSiqg__rZUgyDlTTR03JchnQXgUj7DKDvzS4-QBmJrvw/exec';
    let allData = [];

    const defectsByProcess = {
      "1": [
        { code: "1.1", name: "Wet Mass แฉะเกินไป" },
        { code: "1.2", name: "Wet Mass ไม่สม่ำเสมอ" },
        { code: "1.3", name: "Wet Mass เหนียวเกินไป" }
      ],
      "2": [
        { code: "2.1", name: "Wet Granule แฉะเกินไป" },
        { code: "2.2", name: "Wet Granule แร่งไม่ออก" }
      ],
      "3": [
        { code: "3.1", name: "ความชื้นสูงกว่ากำหนด" },
        { code: "3.2", name: "ความชื้นต่ำกว่ากำหนด" }
      ],
      "4": [{ code: "4.1", name: "ผงแตกละเอียดมากเกิน" }],
      "5": [{ code: "5.1", name: "ผงยาไม่สม่ำเสมอ" }],
      "6": [
        { code: "6.1", name: "เม็ดยานิ่ม" },
        { code: "6.2", name: "เม็ดยาบิ่น" },
        { code: "6.3", name: "เม็ดยาแข็ง" },
        { code: "6.4", name: "ความหนาไม่ได้มาตรฐาน" },
        { code: "6.5", name: "ขึ้นรูปไม่ได้" }
      ],
      "7": [
        { code: "7.1", name: "ซองยารั่ว" },
        { code: "7.2", name: "ซองเบี้ยวหรือผิดรูป" },
        { code: "7.3", name: "จำนวนเม็ดไม่ครบ" },
        { code: "7.4", name: "จำนวนเม็ดเกิน" }
      ]
    };

    async function loadData() {
      try {
        const response = await fetch(API_URL);
        allData = await response.json();
        filterAndDisplay();
      } catch (error) {
        console.error('Error:', error);
        document.getElementById('cardsContainer').innerHTML = `
          <div class="no-results">
            <i class="fas fa-exclamation-triangle"></i>
            <p>ไม่สามารถโหลดข้อมูลได้</p>
          </div>
        `;
      }
    }

    function getThumbnailFromUrl(url) {
      if (!url) return '';
      let match = String(url).match(/file\/d\/([^\/]+)/);
      if (match && match[1]) return `https://drive.google.com/thumbnail?id=${match[1]}&sz=w600`;
      match = String(url).match(/[?&]id=([^&]+)/);
      if (match && match[1]) return `https://drive.google.com/thumbnail?id=${match[1]}&sz=w600`;
      if (String(url).includes('drive.google.com/thumbnail')) return String(url);
      return String(url);
    }

    function createCard(item) {
      const typeClass = String(item.Type || '').toLowerCase();

      const thumbSource = item.ThumbnailURL || item.FileURL || '';
      const thumbnail = getThumbnailFromUrl(thumbSource) || 'https://via.placeholder.com/400x200?text=No+Image';

      // ✅ สำคัญ: แสดง “ปัญหา/สาเหตุ” เฉพาะเมื่อมีข้อมูลจริงเท่านั้น
      const defectText = String(item.DefectName || '').trim();
      const causeText  = String(item.CauseCategory || '').trim();

      const problemLine = defectText
        ? `<p class="card-info"><strong>ปัญหา:</strong> ${defectText}</p>`
        : '';

      const causeLine = causeText
        ? `<p class="card-info"><strong>สาเหตุ:</strong> ${causeText}</p>`
        : '';

      return `
        <div class="card">
          <img src="${thumbnail}" alt="${item.FileName || ''}" class="card-image"
               onerror="this.src='https://via.placeholder.com/400x200?text=No+Image'">
          <div class="card-content">
            <span class="card-type ${typeClass}">${item.Type || ''}</span>
            <h3 class="card-title">${item.FileName || ''}</h3>
            <p class="card-info"><strong>กระบวนการ:</strong> ${item.ProcessName || ''}</p>
            ${problemLine}
            ${causeLine}
            <a href="${item.FileURL || '#'}" target="_blank" class="card-btn">
              ${item.Type === 'Video' ? 'เปิดดูวิดีโอ' : 'เปิดเอกสาร'}
            </a>
          </div>
        </div>
      `;
    }

    function filterAndDisplay() {
      const process = document.getElementById('filterProcess').value;
      const defect = document.getElementById('filterDefect').value;

      const types = [];
      if (document.getElementById('typeOPL').checked) types.push('OPL');
      if (document.getElementById('typeWI').checked) types.push('WI');
      if (document.getElementById('typeVideo').checked) types.push('Video');
      if (document.getElementById('typeExp').checked) types.push('Experience');

      const filtered = allData.filter(item => {
        if (process && String(item.Process) != process) return false;
        if (defect && String(item.DefectCode) != defect) return false;
        if (!types.includes(item.Type)) return false;
        return true;
      });

      const container = document.getElementById('cardsContainer');
      if (filtered.length === 0) {
        container.innerHTML = `
          <div class="no-results">
            <i class="fas fa-search"></i>
            <p>ไม่พบข้อมูลที่ตรงกับเงื่อนไข</p>
          </div>
        `;
      } else {
        container.innerHTML = filtered.map(createCard).join('');
      }
    }

    function updateDefectDropdown() {
      const process = document.getElementById('filterProcess').value;
      const defectSelect = document.getElementById('filterDefect');

      defectSelect.innerHTML = '<option value="">-- ทั้งหมด --</option>';
      if (process && defectsByProcess[process]) {
        defectsByProcess[process].forEach(d => {
          defectSelect.innerHTML += `<option value="${d.code}">${d.code} ${d.name}</option>`;
        });
      }
      filterAndDisplay();
    }

    function clearFilters() {
      document.getElementById('filterProcess').value = '';
      document.getElementById('filterDefect').value = '';
      document.getElementById('typeOPL').checked = true;
      document.getElementById('typeWI').checked = true;
      document.getElementById('typeVideo').checked = true;
      document.getElementById('typeExp').checked = true;
      updateDefectDropdown();
    }

    document.getElementById('filterProcess').addEventListener('change', updateDefectDropdown);
    document.getElementById('filterDefect').addEventListener('change', filterAndDisplay);
    document.getElementById('typeOPL').addEventListener('change', filterAndDisplay);
    document.getElementById('typeWI').addEventListener('change', filterAndDisplay);
    document.getElementById('typeVideo').addEventListener('change', filterAndDisplay);
    document.getElementById('typeExp').addEventListener('change', filterAndDisplay);

    loadData();
  </script>
</body>
</html>
