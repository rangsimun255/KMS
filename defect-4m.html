<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>4M Cause - KMS</title>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Sarabun',sans-serif;background:#e8eef5;min-height:100vh;overflow-x:hidden}
    .container{display:flex;min-height:100vh}

    .sidebar{width:70px;background:linear-gradient(180deg,#5b9bd5 0%,#4a89c8 100%);display:flex;flex-direction:column;align-items:center;padding-top:20px;gap:10px;position:fixed;height:100vh;left:0;top:0;z-index:100}
    .sidebar-icon{width:50px;height:50px;display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,.7);font-size:20px;border-radius:12px;cursor:pointer;transition:.2s;text-decoration:none}
    .sidebar-icon:hover,.sidebar-icon.active{background:rgba(255,255,255,.2);color:#fff}

    .main-content{flex:1;margin-left:70px;width:calc(100% - 70px)}
    .header{background:linear-gradient(135deg,#5b9bd5 0%,#2e75b6 100%);padding:28px 18px;text-align:center}
    .header h1{color:#fff;font-size:24px;font-weight:900;margin-bottom:6px}
    .header p{color:rgba(255,255,255,.92);font-size:14px}

    .wrap{padding:14px}
    .topbar{background:#fff;border-radius:16px;padding:12px 14px;box-shadow:0 2px 10px rgba(0,0,0,.08);display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:12px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:#e3f2fd;color:#1565c0;font-weight:900;font-size:13px}
    .btn-back{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;background:#5b9bd5;color:#fff;text-decoration:none;font-weight:900}
    .btn-back:hover{background:#4a89c8}

    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}

    .card{background:#fff;border-radius:18px;box-shadow:0 6px 18px rgba(0,0,0,.10);overflow:hidden}
    .card-head{padding:14px;border-bottom:1px solid #eef3f8;display:flex;align-items:center;gap:10px}
    .icon{width:44px;height:44px;border-radius:16px;background:#5b9bd5;color:#fff;display:flex;align-items:center;justify-content:center;font-size:18px}
    .h-title{font-weight:900;color:#1f2d3d;font-size:18px}
    .h-sub{color:#607d8b;font-size:13px;margin-top:4px}

    .card-body{padding:14px;display:flex;flex-direction:column;gap:10px}
    .box{border-radius:14px;border:1px solid #e9eef6;background:#f7fbff;padding:12px}
    .box h3{font-size:13px;color:#2e75b6;font-weight:900;margin-bottom:6px}
    .box p{font-size:14px;color:#34495e;line-height:1.55}

    .loading,.error{background:#fff;border-radius:16px;padding:30px;box-shadow:0 2px 10px rgba(0,0,0,.08);text-align:center;color:#607d8b}
    .error{color:#c62828}

    @media(max-width:768px){
      .container{flex-direction:column}
      .sidebar{width:100%;height:60px;flex-direction:row;justify-content:center;position:relative;padding:10px;gap:12px}
      .main-content{margin-left:0;width:100%}
    }
  </style>
</head>

<body>
<div class="container">
  <nav class="sidebar">
  <a class="sidebar-icon" data-page="index" href="index.html"><i class="fas fa-home"></i></a>
  <a class="sidebar-icon" data-page="kb" href="knowledge-base.html"><i class="fas fa-book"></i></a>
  <a class="sidebar-icon" data-page="lp" href="learning-path.html"><i class="fas fa-graduation-cap"></i></a>
  <a class="sidebar-icon" data-page="quiz" href="quiz.html"><i class="fas fa-clipboard-check"></i></a>
  <a class="sidebar-icon" data-page="share" href="share-experience.html"><i class="fas fa-comments"></i></a>
  <a class="sidebar-icon logout" href="#"><i class="fas fa-sign-out-alt"></i></a>
</nav>


  <main class="main-content">
    <header class="header">
      <h1>สาเหตุ (4M)</h1>
      <p>1 สาเหตุ + 2 แนวทางป้องกัน/แก้ไข ต่อ 1 หมวด</p>
    </header>

    <div class="wrap">
      <div class="topbar">
        <span class="pill"><i class="fas fa-diagram-project"></i> <span id="titleText">Process - Defect</span></span>
        <a class="btn-back" id="backBtn" href="#"><i class="fas fa-arrow-left"></i> กลับหน้าลักษณะของเสีย</a>
      </div>

      <div id="content" class="loading">
        <i class="fas fa-spinner fa-spin"></i><div>กำลังโหลดข้อมูล...</div>
      </div>
    </div>
  </main>
</div>

<script>
  const API_BASE = "https://script.google.com/macros/s/AKfycbwMRbnqSLTmmI4wofmNfZ5YPFGSiqg__rZUgyDlTTR03JchnQXgUj7DKDvzS4-QBmJrvw/exec";
  const iconMap = {
    "Man": "fa-user",
    "Machine": "fa-gears",
    "Material": "fa-cubes",
    "Method": "fa-list-check"
  };
  const titleMap = {
    "Man": "Man (คน)",
    "Machine": "Machine (เครื่องจักร)",
    "Material": "Material (วัตถุดิบ)",
    "Method": "Method (วิธีการ)"
  };

  function getQueryParam(name){
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
  }
  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;").replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function pickFirstRowByType(rows, type){
    return rows.find(r => String(r.M_Type).trim() === type) || null;
  }

  function renderCard(type, row){
    const icon = iconMap[type] || "fa-circle";
    const t = titleMap[type] || type;

    const cause = row ? String(row.CauseDescription || "").trim() : "";
    const p1 = row ? String(row.Prevention1 || "").trim() : "";
    const p2 = row ? String(row.Prevention2 || "").trim() : "";

    const safeCause = cause || "ยังไม่มีข้อมูลสาเหตุ (ใส่เพิ่มในชีท Defect 4M)";
    const safeP1 = p1 || "ยังไม่มีแนวทางป้องกัน/แก้ไข #1";
    const safeP2 = p2 || "ยังไม่มีแนวทางป้องกัน/แก้ไข #2";

    return `
      <section class="card">
        <div class="card-head">
          <div class="icon"><i class="fas ${esc(icon)}"></i></div>
          <div>
            <div class="h-title">${esc(t)}</div>
            <div class="h-sub">โฟกัสให้พนักงานใหม่เข้าใจเร็ว</div>
          </div>
        </div>

        <div class="card-body">
          <div class="box">
            <h3><i class="fas fa-bug"></i> สาเหตุ (1 ข้อ)</h3>
            <p>${esc(safeCause)}</p>
          </div>
          <div class="box">
            <h3><i class="fas fa-shield-halved"></i> การป้องกัน/แก้ไข (2 ข้อ)</h3>
            <p>1) ${esc(safeP1)}</p>
            <p>2) ${esc(safeP2)}</p>
          </div>
        </div>
      </section>
    `;
  }

  async function load(){
    const proc = String(getQueryParam("process") || "").trim();
    const defect = String(getQueryParam("defect") || "").trim();

    // ปุ่มกลับไป defect-learning
    document.getElementById("backBtn").href = `defect-learning.html?process=${encodeURIComponent(proc)}`;

    // หัวข้อ
    document.getElementById("titleText").textContent = `Process ${proc} • Defect ${defect}`;

    if(!proc || !defect){
      document.getElementById("content").className = "error";
      document.getElementById("content").innerHTML = `ขาดพารามิเตอร์ process/defect`;
      return;
    }

    try{
      const url = `${API_BASE}?view=4m&process=${encodeURIComponent(proc)}&defect=${encodeURIComponent(defect)}`;
      const res = await fetch(url);
      const rows = await res.json();

      const list = Array.isArray(rows) ? rows : [];

      const man = pickFirstRowByType(list, "Man");
      const machine = pickFirstRowByType(list, "Machine");
      const material = pickFirstRowByType(list, "Material");
      const method = pickFirstRowByType(list, "Method");

      document.getElementById("content").className = "";
      document.getElementById("content").innerHTML = `
        <div class="grid">
          ${renderCard("Man", man)}
          ${renderCard("Machine", machine)}
          ${renderCard("Material", material)}
          ${renderCard("Method", method)}
        </div>
      `;
    }catch(err){
      console.error(err);
      document.getElementById("content").className = "error";
      document.getElementById("content").innerHTML = `โหลดข้อมูลไม่สำเร็จ`;
    }
  }

  load();
</script>
<script src="Js"></script>

</body>
</html>
