<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>4M Cause - KMS</title>

  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    *{margin:0;padding:0;box-sizing:border-box}

    body{
      font-family:'Sarabun',sans-serif;
      background:#F4F7FB;
      min-height:100vh;
      overflow-x:hidden;
      color:#2E3A59;
      font-size:14px;
      line-height:1.7;
    }

    .container{display:flex;min-height:100vh}

    /* Sidebar */
    .sidebar{
      width:70px;
      background:linear-gradient(180deg,#4A89C8 0%,#2E75B6 100%);
      display:flex;flex-direction:column;align-items:center;
      padding-top:20px;gap:10px;
      position:fixed;height:100vh;left:0;top:0;z-index:100;
    }
    .sidebar-icon{
      width:50px;height:50px;display:flex;align-items:center;justify-content:center;
      color:rgba(255,255,255,.85);font-size:20px;border-radius:12px;
      cursor:pointer;transition:.2s;text-decoration:none;
      -webkit-tap-highlight-color:transparent;
      user-select:none;
    }
    .sidebar-icon:hover,.sidebar-icon.active{background:rgba(255,255,255,.18);color:#fff}

    .main-content{flex:1;margin-left:70px;width:calc(100% - 70px)}

    .header{
      background:linear-gradient(135deg,#4A89C8 0%,#2E75B6 100%);
      padding:60px 40px;
      text-align:center;
      box-shadow:0 4px 15px rgba(74,137,200,0.25);
    }
    .header h1{
      color:#fff;
      font-size:42px;
      font-weight:700;
      margin-bottom:15px;
      letter-spacing:1px;
      text-shadow:0 2px 4px rgba(0,0,0,0.2);
    }
    .header p{
      color:rgba(255,255,255,.95);
      font-size:18px;
      max-width:650px;
      margin:0 auto;
      line-height:1.7;
    }

    .wrap{padding:16px 18px 24px}

    .topbar{
      background:#fff;
      border-radius:16px;
      padding:12px 14px;
      box-shadow:0 2px 10px rgba(46,58,89,.08);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      flex-wrap:wrap;margin-bottom:12px
    }
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      background:#E6F0FA;color:#2E75B6;font-weight:900;font-size:13px
    }

    /* ✅ เปลี่ยนปุ่มจาก back เป็น next */
    .btn-back{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:12px;
      background:#4A89C8;color:#fff;text-decoration:none;font-weight:900
    }
    .btn-back:hover{background:#2E75B6}
    .btn-back.disabled{opacity:.55;pointer-events:none}

    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}

    .card{
      background:#fff;
      border-radius:18px;
      box-shadow:0 6px 18px rgba(46,58,89,.10);
      overflow:visible;
      border:1px solid rgba(74,137,200,0.12);
    }
    .card.dropdown-open{position:relative;z-index:30}

    .card-head{
      padding:14px;
      border-bottom:1px solid #EEF3F8;
      display:flex;align-items:center;gap:10px
    }
    .icon{
      width:44px;height:44px;border-radius:16px;
      background:#4A89C8;color:#fff;
      display:flex;align-items:center;justify-content:center;font-size:18px
    }
    .h-title{font-weight:900;color:#1F2D3D;font-size:18px}
    .h-sub{color:#6B7A90;font-size:13px;margin-top:4px}

    .card-body{padding:14px;display:flex;flex-direction:column;gap:10px}
    .box{
      border-radius:14px;
      border:1px solid #E8F1FB;
      background:#F7FBFF;
      padding:12px
    }
    .box h3{font-size:13px;color:#2E75B6;font-weight:900;margin-bottom:6px}
    .box p{font-size:14px;color:#34495e;line-height:1.55}

    .loading,.error{
      background:#fff;border-radius:16px;padding:30px;
      box-shadow:0 2px 10px rgba(46,58,89,.08);
      text-align:center;color:#6B7A90
    }
    .error{color:#c62828}

    /* Dropdown */
    .dropdown{position:relative;width:100%;max-width:100%}
    .drop-btn{
      width:100%;
      max-width:100%;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:10px 12px;border-radius:12px;
      background:#2E75B6;color:#fff;font-weight:900;font-size:13px;
      border:none;cursor:pointer;overflow:hidden;
    }
    .drop-btn:hover{background:#1f5f97}
    .drop-btn span{display:flex;align-items:center;gap:10px;min-width:0}
    .drop-btn .label{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .drop-menu{
      display:none;position:absolute;left:0;right:0;top:calc(100% + 8px);
      background:#fff;border:1px solid #E9EEF6;border-radius:12px;
      box-shadow:0 10px 24px rgba(46,58,89,.12);
      z-index:999;max-height:240px;overflow-y:auto;overflow-x:hidden;
    }
    .dropdown.open .drop-menu{display:block}

    .drop-item{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;color:#1f2d3d;text-decoration:none;
      font-weight:800;font-size:13px;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .drop-item:hover{background:#f3f7ff}
    .drop-item i{color:#2E75B6;flex:0 0 auto}

    @media(max-width:768px){
      .container{flex-direction:column}
      .sidebar{
        width:100%;
        height:60px;
        flex-direction:row;
        justify-content:center;
        position:relative;
        padding:10px;
        gap:12px
      }
      .main-content{margin-left:0;width:100%}
      .header{padding:40px 20px}
      .header h1{font-size:28px}
      .header p{font-size:15px}
      .wrap{padding:12px 12px 20px}
    }
  </style>
</head>

<body>
<div class="container">
  <nav class="sidebar">
    <a class="sidebar-icon" href="index.html"><i class="fas fa-home"></i></a>
    <a class="sidebar-icon" href="knowledge-base.html"><i class="fas fa-book"></i></a>
    <a class="sidebar-icon" href="learning-path.html"><i class="fas fa-graduation-cap"></i></a>
    <a class="sidebar-icon" href="quiz.html"><i class="fas fa-clipboard-check"></i></a>
    <a class="sidebar-icon" href="share-experience.html"><i class="fas fa-comments"></i></a>
    <a class="sidebar-icon logout" href="#"><i class="fas fa-sign-out-alt"></i></a>
  </nav>

  <main class="main-content">
    <header class="header">
      <h1>สาเหตุ (4M)</h1>
      <p>1 สาเหตุ + 1 แนวทางป้องกัน/แก้ไข ต่อ 1 หมวด</p>
    </header>

    <div class="wrap">
      <div class="topbar">
        <span class="pill"><i class="fas fa-diagram-project"></i> <span id="titleText">Process - Defect</span></span>

        <!-- ✅ ปุ่มใหม่: ไปยังลักษณะของเสียถัดไป -->
        <a class="btn-back" id="nextBtn" href="#">
          ไปยังลักษณะของเสียถัดไป <i class="fas fa-arrow-right"></i>
        </a>
      </div>

      <div id="content" class="loading">
        <i class="fas fa-spinner fa-spin"></i><div>กำลังโหลดข้อมูล...</div>
      </div>
    </div>
  </main>
</div>

<script>
  const API_BASE = "https://script.google.com/macros/s/AKfycbwMRbnqSLTmmI4wofmNfZ5YPFGSiqg__rZUgyDlTTR03JchnQXgUj7DKDvzS4-QBmJrvw/exec";

  // ✅ ใช้ตัวเดียวกับหน้า defect-learning เพื่อ “หา defect ถัดไป”
  const DEFECT_LEARNING_API = API_BASE + "?view=defectlearning";

  const iconMap = {
    "Man": "fa-user",
    "Machine": "fa-gears",
    "Material": "fa-cubes",
    "Method": "fa-list-check"
  };
  const titleMap = {
    "Man": "Man (คน)",
    "Machine": "Machine (เครื่องจักร)",
    "Material": "Material (วัตถุดิบ)",
    "Method": "Method (วิธีการ)"
  };

  function getQueryParam(name){
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
  }

  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function pickFirstRowByType(rows, type){
    return rows.find(r => String(r.M_Type).trim() === type) || null;
  }

  async function fetchShortcuts(proc, defect, cat){
    const url = `${API_BASE}?view=shortcuts&process=${encodeURIComponent(proc)}&defect=${encodeURIComponent(defect)}&cat=${encodeURIComponent(cat)}`;
    const res = await fetch(url);
    const data = await res.json();
    return Array.isArray(data) ? data : [];
  }

  function renderCard(type, row, shortcuts){
    const icon = iconMap[type] || "fa-circle";
    const t = titleMap[type] || type;

    const cause = row ? String(row.CauseDescription || "").trim() : "";
    const p1 = row ? String(row.Prevention1 || "").trim() : "";

    const safeCause = cause || "ยังไม่มีข้อมูลสาเหตุ (ใส่เพิ่มในชีท Defect 4M)";
    const safeP1 = p1 || "ยังไม่มีแนวทางป้องกัน/แก้ไข";

    const list = Array.isArray(shortcuts) ? shortcuts : [];

    let shortcutBlock = `
      <div class="box">
        <h3><i class="fas fa-link"></i> สื่อทางลัด (จาก KMS Base)</h3>
        <p>ยังไม่มีไฟล์สำหรับ DefectCode นี้ในหมวด ${esc(type)}</p>
      </div>
    `;

    if(list.length){
      const items = list.map((s) => {
        const name = (s.FileName && String(s.FileName).trim()) ? String(s.FileName).trim() : "เอกสาร";
        return `
          <a class="drop-item" target="_blank" rel="noopener" href="${esc(s.FileURL)}" title="${esc(name)}">
            <i class="fas fa-file-lines"></i> ${esc(name)}
          </a>
        `;
      }).join("");

      shortcutBlock = `
        <div class="box">
          <h3><i class="fas fa-link"></i> สื่อทางลัด (จาก KMS Base)</h3>
          <div class="dropdown" data-dropdown>
            <button class="drop-btn" type="button">
              <span><i class="fas fa-bolt"></i> <span class="label">เปิดไฟล์</span></span>
              <i class="fas fa-caret-down"></i>
            </button>
            <div class="drop-menu">
              ${items}
            </div>
          </div>
        </div>
      `;
    }

    return `
      <section class="card">
        <div class="card-head">
          <div class="icon"><i class="fas ${esc(icon)}"></i></div>
          <div>
            <div class="h-title">${esc(t)}</div>
            <div class="h-sub">โฟกัสให้พนักงานใหม่เข้าใจเร็ว</div>
          </div>
        </div>

        <div class="card-body">
          <div class="box">
            <h3><i class="fas fa-bug"></i> สาเหตุ (1 ข้อ)</h3>
            <p>${esc(safeCause)}</p>
          </div>

          <div class="box">
            <h3><i class="fas fa-shield-halved"></i> การป้องกัน/แก้ไข (1 ข้อ)</h3>
            <p>${esc(safeP1)}</p>
          </div>

          ${shortcutBlock}
        </div>
      </section>
    `;
  }

  // ✅ ตั้งค่าปุ่ม “ไปยังลักษณะของเสียถัดไป” ให้ไป defect ถัดไปจริง
  async function setupNextButton(proc, defect){
    const btn = document.getElementById("nextBtn");

    // fallback: ถ้าอะไรก็พัง ให้กลับไปหน้า defect-learning
    btn.href = `defect-learning.html?process=${encodeURIComponent(proc)}`;

    try{
      const res = await fetch(DEFECT_LEARNING_API);
      const data = await res.json();

      const defects = (Array.isArray(data) ? data : [])
        .filter(x => String(x.Process).trim() === String(proc).trim())
        .sort((a,b)=> String(a.DefectCode).localeCompare(String(b.DefectCode), 'th'));

      if(!defects.length){
        btn.classList.add("disabled");
        btn.innerHTML = `ไม่พบรายการลักษณะของเสีย`;
        return;
      }

      const cur = String(defect).trim();
      const idx = defects.findIndex(x => String(x.DefectCode).trim() === cur);

      if(idx < 0){
        // ไม่เจอ defect ปัจจุบันใน list -> ส่งกลับหน้า list
        btn.href = `defect-learning.html?process=${encodeURIComponent(proc)}`;
        return;
      }

      // ✅ ถ้าเป็นอันสุดท้าย จะวนกลับไปอันแรก (อยากให้ “กลับหน้าเลือกกระบวนการ” ก็บอก เดี๋ยวแก้)
      const next = defects[idx + 1] || defects[0];
      const nextCode = String(next.DefectCode).trim();

      btn.href = `defect-learning.html?process=${encodeURIComponent(proc)}&defect=${encodeURIComponent(nextCode)}`;

    }catch(e){
      btn.href = `defect-learning.html?process=${encodeURIComponent(proc)}`;
    }
  }

  async function load(){
    const proc = String(getQueryParam("process") || "").trim();
    const defect = String(getQueryParam("defect") || "").trim();

    document.getElementById("titleText").textContent = `Process ${proc} • Defect ${defect}`;

    if(!proc || !defect){
      document.getElementById("content").className = "error";
      document.getElementById("content").innerHTML = `ขาดพารามิเตอร์ process/defect`;
      return;
    }

    // ✅ ทำให้ปุ่มไป defect ถัดไปจริง
    setupNextButton(proc, defect);

    try{
      const url4m = `${API_BASE}?view=defect4m&process=${encodeURIComponent(proc)}&defect=${encodeURIComponent(defect)}`;
      const res4m = await fetch(url4m);
      const rows = await res4m.json();
      const list = Array.isArray(rows) ? rows : [];

      const man = pickFirstRowByType(list, "Man");
      const machine = pickFirstRowByType(list, "Machine");
      const material = pickFirstRowByType(list, "Material");
      const method = pickFirstRowByType(list, "Method");

      const [manLinks, machineLinks, materialLinks, methodLinks] = await Promise.all([
        fetchShortcuts(proc, defect, "Man"),
        fetchShortcuts(proc, defect, "Machine"),
        fetchShortcuts(proc, defect, "Material"),
        fetchShortcuts(proc, defect, "Method"),
      ]);

      document.getElementById("content").className = "";
      document.getElementById("content").innerHTML = `
        <div class="grid">
          ${renderCard("Man", man, manLinks)}
          ${renderCard("Machine", machine, machineLinks)}
          ${renderCard("Material", material, materialLinks)}
          ${renderCard("Method", method, methodLinks)}
        </div>
      `;
    }catch(err){
      console.error(err);
      document.getElementById("content").className = "error";
      document.getElementById("content").innerHTML = `โหลดข้อมูลไม่สำเร็จ`;
    }
  }

  load();

  // Dropdown toggle + ยก z-index การ์ดตอนเปิด
  document.addEventListener("click", (e) => {
    const btn = e.target.closest(".drop-btn");
    const dropdown = e.target.closest("[data-dropdown]");

    document.querySelectorAll("[data-dropdown].open").forEach(d => d.classList.remove("open"));
    document.querySelectorAll(".card.dropdown-open").forEach(c => c.classList.remove("dropdown-open"));

    if(btn && dropdown){
      dropdown.classList.add("open");
      const card = dropdown.closest(".card");
      if(card) card.classList.add("dropdown-open");
      return;
    }
  });
</script>

</body>
</html>
