<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Learning Path - KMS</title>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Sarabun',sans-serif;background:#e8eef5;min-height:100vh;overflow-x:hidden}
    .container{display:flex;min-height:100vh}

    .sidebar{width:70px;background:linear-gradient(180deg,#5b9bd5 0%,#4a89c8 100%);
      display:flex;flex-direction:column;align-items:center;padding-top:20px;gap:10px;
      position:fixed;left:0;top:0;height:100vh;z-index:100}
    .sidebar-icon{width:50px;height:50px;display:flex;align-items:center;justify-content:center;
      color:rgba(255,255,255,.7);font-size:20px;border-radius:12px;cursor:pointer;transition:.2s;text-decoration:none}
    .sidebar-icon:hover,.sidebar-icon.active{background:rgba(255,255,255,.2);color:#fff}

    .main{flex:1;margin-left:70px;width:calc(100% - 70px)}
    .header{background:linear-gradient(135deg,#5b9bd5 0%,#2e75b6 100%);padding:34px 40px;text-align:center}
    .header h1{color:#fff;font-size:30px;font-weight:700;margin-bottom:8px}
    .header p{color:rgba(255,255,255,.92);font-size:14px;line-height:1.6}

    .wrap{padding:18px 40px 40px}
    .topbar{display:flex;gap:14px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:14px}
    .select{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    select{padding:10px 12px;border:2px solid #e0e0e0;border-radius:10px;min-width:240px;font-size:14px}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border-radius:999px;background:#eef5ff;color:#2e75b6;font-weight:700;font-size:12px}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
    .card{background:#fff;border-radius:16px;box-shadow:0 4px 15px rgba(0,0,0,.06);overflow:hidden}
    .card-h{padding:14px 16px;border-bottom:1px solid #eef2f6;font-weight:800;color:#2c3e50}
    .card-b{padding:14px 16px}
    .step{border:1px solid #edf0f5;border-radius:14px;padding:12px 12px;margin-bottom:10px}
    .step .t{font-weight:800;color:#2c3e50;margin-bottom:6px}
    .meta{font-size:12px;color:#7f8c8d;line-height:1.6}
    .btn{display:inline-flex;align-items:center;gap:8px;border:none;border-radius:10px;padding:10px 12px;
      font-weight:800;cursor:pointer;text-decoration:none}
    .btn-primary{background:#5b9bd5;color:#fff}
    .btn-primary:hover{background:#4a89c8}
    .list{display:flex;flex-direction:column;gap:10px}
    .kb-item{border:1px solid #edf0f5;border-radius:14px;padding:12px}
    .kb-title{font-weight:800;color:#2c3e50;margin-bottom:6px}
    .kb-sub{font-size:12px;color:#7f8c8d;margin-bottom:8px}
    .empty{padding:18px;color:#7f8c8d}

    @media(max-width:1000px){.grid{grid-template-columns:1fr}}
    @media(max-width:900px){
      .container{flex-direction:column}
      .sidebar{width:100%;height:60px;flex-direction:row;justify-content:center;padding:10px;position:sticky}
      .main{margin-left:0;width:100%}
      .wrap{padding:16px}
    }
  </style>
</head>

<body>
  <div class="container">
    <nav class="sidebar">
      <a href="index.html" class="sidebar-icon" title="Home"><i class="fas fa-home"></i></a>
      <a href="knowledge-base.html" class="sidebar-icon" title="Knowledge Base"><i class="fas fa-book-open"></i></a>
      <a href="learning-path.html" class="sidebar-icon active" title="Learning Path"><i class="fas fa-graduation-cap"></i></a>
      <a href="quiz.html" class="sidebar-icon" title="Quiz"><i class="fas fa-clipboard-check"></i></a>
      <a href="share-experience.html" class="sidebar-icon" title="Share Experience"><i class="fas fa-comments"></i></a>
    </nav>

    <main class="main">
      <header class="header">
        <h1>Learning Path</h1>
        <p>เลือกกระบวนการ 1–7 → เรียนแบบสั้น กระชับ → เห็นผลกระทบต่อขั้นถัดไป + ลิงก์ไฟล์ความรู้ที่เกี่ยวข้อง</p>
      </header>

      <div class="wrap">
        <div class="topbar">
          <div class="select">
            <span class="pill"><i class="fa-solid fa-route"></i> เลือกกระบวนการ</span>
            <select id="procSelect">
              <option value="1">1) ผสมเปียก</option>
              <option value="2">2) แร่งเปียก</option>
              <option value="3">3) อบลมร้อน</option>
              <option value="4">4) แร่งแห้ง</option>
              <option value="5">5) ผสมแห้ง</option>
              <option value="6">6) ตอกเม็ดยา</option>
              <option value="7">7) บรรจุซอง</option>
            </select>
          </div>
          <a class="btn btn-primary" href="knowledge-base.html"><i class="fa-solid fa-book"></i> ไปดู Knowledge Base</a>
        </div>

        <div class="grid">
          <section class="card">
            <div class="card-h">แผนการเรียน (Process)</div>
            <div class="card-b" id="stepsBox">
              <div class="empty"><i class="fa-solid fa-spinner fa-spin"></i> กำลังโหลดแผน...</div>
            </div>
          </section>

          <aside class="card">
            <div class="card-h">ไฟล์ที่แนะนำ (OPL/WI/Video/Experience)</div>
            <div class="card-b">
              <div class="list" id="kbBox">
                <div class="empty"><i class="fa-solid fa-spinner fa-spin"></i> กำลังโหลดไฟล์...</div>
              </div>
            </div>
          </aside>
        </div>
      </div>
    </main>
  </div>

  <script>
    // ✅ API รวม KMS Base + KMS Share (ตัวเดียวกับหน้า Knowledge Base)
    const KB_API = 'https://script.google.com/macros/s/AKfycbwMRbnqSLTmmI4wofmNfZ5YPFGSiqg__rZUgyDlTTR03JchnQXgUj7DKDvzS4-QBmJrvw/exec';

    // ✅ API แผน Learning (จะทำในข้อ 4) เช่น .../exec?mode=learning
    const LEARN_API = KB_API + '?mode=learning';

    let kbData = [];
    let learnPlan = [];

    const procName = {
      "1":"ผสมเปียก","2":"แร่งเปียก","3":"อบลมร้อน","4":"แร่งแห้ง","5":"ผสมแห้ง","6":"ตอกเม็ดยา","7":"บรรจุซอง"
    };

    async function loadAll() {
      const [kbRes, lpRes] = await Promise.all([
        fetch(KB_API).then(r=>r.json()),
        fetch(LEARN_API).then(r=>r.json())
      ]);
      kbData = Array.isArray(kbRes) ? kbRes : [];
      learnPlan = Array.isArray(lpRes) ? lpRes : [];
      render();
    }

    function render() {
      const p = document.getElementById('procSelect').value;

      // ----- Steps -----
      const steps = learnPlan
        .filter(x => String(x.Process) === String(p))
        .sort((a,b)=>Number(a.StepNo||0)-Number(b.StepNo||0));

      const stepsBox = document.getElementById('stepsBox');
      if (steps.length === 0) {
        stepsBox.innerHTML = `<div class="empty">ยังไม่มีแผนสำหรับ Process ${p} (${procName[p]})</div>`;
      } else {
        stepsBox.innerHTML = steps.map(s => `
          <div class="step">
            <div class="t">Step ${s.StepNo}. ${s.Title || ''}</div>
            <div class="meta"><b>เป้าหมาย:</b> ${s.Goal || '-'}</div>
            <div class="meta"><b>Impact ไปขั้น:</b> ${s.ImpactTo || '-'}</div>
            <div class="meta"><b>โฟกัสของเสีย:</b> ${s.DefectsFocus || '-'}</div>
            <div class="meta"><b>4M โฟกัส:</b> ${s.CauseFocus || '-'}</div>
            <div class="meta"><b>เวลา:</b> ${s.TimeMin || '-'} นาที</div>
            <div class="meta"><b>ผ่านเมื่อ:</b> ${s.PassRule || '-'}</div>
          </div>
        `).join('');
      }

      // ----- Recommended KB files (match by Process + optional CauseFocus/DefectsFocus) -----
      const focusDefects = new Set(
        steps.flatMap(s => String(s.DefectsFocus||'').split(',').map(x=>x.trim()).filter(Boolean))
      );
      const focusCause = new Set(
        steps.flatMap(s => String(s.CauseFocus||'').split(',').map(x=>x.trim()).filter(Boolean))
      );

      let items = kbData.filter(x => String(x.Process) === String(p));

      // ถ้ามี defects focus → prioritize
      items = items.sort((a,b)=>{
        const aScore = focusDefects.has(String(a.DefectCode)) ? 2 : 0;
        const bScore = focusDefects.has(String(b.DefectCode)) ? 2 : 0;
        const aC = focusCause.has(String(a.CauseCategory)) ? 1 : 0;
        const bC = focusCause.has(String(b.CauseCategory)) ? 1 : 0;
        return (bScore+bC) - (aScore+aC);
      }).slice(0, 12);

      const kbBox = document.getElementById('kbBox');
      if (items.length === 0) {
        kbBox.innerHTML = `<div class="empty">ยังไม่มีไฟล์ใน Knowledge Base สำหรับ Process ${p}</div>`;
      } else {
        kbBox.innerHTML = items.map(it => `
          <div class="kb-item">
            <div class="kb-title">${it.Type || ''}: ${it.FileName || it.DefectName || ''}</div>
            <div class="kb-sub">
              กระบวนการ: ${it.ProcessName || procName[p] || ''}<br>
              ${it.Type === 'Experience' ? '' : `สาเหตุ: ${it.CauseCategory || '-'}<br>`}
              ${it.Type === 'Experience' ? '' : `ของเสีย: ${it.DefectCode ? it.DefectCode + ' ' : ''}${it.DefectName || ''}`}
            </div>
            <a class="btn btn-primary" target="_blank" href="${it.FileURL || '#'}">
              <i class="fa-solid fa-arrow-up-right-from-square"></i> เปิด
            </a>
          </div>
        `).join('');
      }
    }

    document.getElementById('procSelect').addEventListener('change', render);
    loadAll().catch(()=>{
      document.getElementById('stepsBox').innerHTML = `<div class="empty">โหลดไม่สำเร็จ</div>`;
      document.getElementById('kbBox').innerHTML = `<div class="empty">โหลดไม่สำเร็จ</div>`;
    });
  </script>
</body>
</html>

