<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login - KMS</title>

  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">

  <style>
    *{box-sizing:border-box}
    body{
      font-family:Sarabun,sans-serif;
      background:#eef3f8;
      display:flex;align-items:center;justify-content:center;
      min-height:100vh;margin:0;padding:16px;
    }
    .card{
      width:min(420px,100%);
      background:#fff;
      padding:24px;
      border-radius:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.12);
    }
    h2{text-align:center;margin:0 0 6px}
    p{text-align:center;color:#666;margin:0 0 18px;font-size:13px}
    input{
      width:100%;
      padding:12px 12px;
      margin-bottom:12px;
      border-radius:10px;
      border:1px solid #d6dde6;
      font-size:14px;
      outline:none;
    }
    button{
      width:100%;
      padding:12px;
      border:none;
      border-radius:12px;
      background:#5b9bd5;
      color:#fff;
      font-weight:700;
      cursor:pointer;
    }
    button:active{transform:scale(.99)}
    .msg{
      margin-top:10px;
      text-align:center;
      font-size:13px;
      color:#c62828;
      min-height:18px;

      /* ✅ กันตกขอบ */
      word-break: break-word;
      overflow-wrap: anywhere;
    }
    .ok{color:#2e7d32}
  </style>
</head>
<body>

<div class="card">
  <h2>KMS Admin Login</h2>
  <p>เข้าสู่ระบบผู้ดูแล</p>

  <input id="u" placeholder="Username" autocomplete="username">
  <input id="p" type="password" placeholder="Password" autocomplete="current-password">

  <button id="btn">Sign in</button>
  <div class="msg" id="msg"></div>
</div>

<script>
  // ✅ ใส่ URL /exec ที่ Deploy ล่าสุด (ห้ามซ้อน 2 อันติดกัน)
  const API_URL = "https://script.google.com/macros/s/AKfycbwMRbnqSLTmmI4wofmNfZ5YPFGSiqg__rZUgyDlTTR03JchnQXgUj7DKDvzS4-QBmJrvw/exec";

  // ถ้าเคย login แล้ว ให้เข้า home เลย
  if (localStorage.getItem("kms_token")) location.href = "index.html";

  const $u = document.getElementById("u");
  const $p = document.getElementById("p");
  const $msg = document.getElementById("msg");
  const $btn = document.getElementById("btn");

  function setMsg(t, ok=false){
    $msg.textContent = t || "";
    $msg.className = "msg" + (ok ? " ok" : "");
  }

  async function login(){
    setMsg("");
    const username = $u.value.trim();
    const password = $p.value.trim();

    if(!username || !password){
      setMsg("กรุณากรอก Username และ Password");
      return;
    }

    try{
      $btn.disabled = true;

      // ✅ ส่งแบบ form-urlencoded (Apps Script อ่านจาก e.parameter ได้เลย)
      const body = new URLSearchParams({
        action: "login",
        username,
        password
      });

      const res = await fetch(API_URL, {
        method: "POST",
        body
      });

      const data = await res.json();

      if(data && data.ok){
        localStorage.setItem("kms_token", data.token);
        setMsg("Login สำเร็จ", true);
        location.href = "index.html";
      }else{
        setMsg(data?.error || "Login ไม่สำเร็จ");
      }
    }catch(err){
      console.error(err);
      setMsg("เชื่อมต่อ API ไม่ได้ (ตรวจ Deploy / URL / สิทธิ์ Anyone)");
    }finally{
      $btn.disabled = false;
    }
  }

  $btn.addEventListener("click", login);
  document.addEventListener("keydown", (e)=>{ if(e.key==="Enter") login(); });
</script>

</body>
</html>
